#! /usr/bin/bash
filsz(){
f=;d=;vr=v;p=~+;x='tmp(.tmp)?,bak,old'
for o
{
case ${o:0:2} in
-x)	
	x=${o#-x[= ]};;
-d)
	o=${o#-d[= ]/}
	a=${o%,*};b=${o#*,}
	o=${a:+"-mindepth $a "}${b:+"-maxdepth $b "};;
-n)	vr=;;
/[a-z])
	if test -d "$o" ;then
		p=$o
	elif test -f $o ;then
		p=${o%/*}
		f=${o##*/}
	else	echo Directory or file does not exist;exit 1
	fi;;
*)
	p=~+/$o
	if test -f $p ;then
		f=$o
	elif test ! -d $p ;then	echo Option is unknown or directory does not exist;exit 1
	fi;;
esac
}
x="${x//./\\.}"
xt="\.(${x//,/|})"
fn=${f:+`echo $f| sed -E 's/[{}\.$]/\\\&/g; s/\*/.*/g; s/\?/./'`}
fn=${fn:-'[^/]+'}
y=0;a=;b=
IFS=$'\r\n'  # set it for Windows port-Msys : \r\n, Mac: \r
s==;while(test "$s")
do
u="find $p -noleaf $d -type f -regextype posix-extended -iregex \".*/$fn$xt\" -printf \"%p %s\n\" |head -n313"
s=
for s in `eval $u`
{
	f=${s% *}
	e=`echo $f| sed -E "s'^(.*)$xt\$'\1'"`
	z=${s##* }
	if test "$e" = "$a" ;then
		if test $z -lt $y	;then
			rm -f$vr $f
		elif test $z -gt $y	;then
			mv -f$vr $f ${b:-$a}
			y=$z
		elif test `find ${e%/*} -noleaf -maxdepth 1 -type f -iname "${f##*/}" -newer "$b"`
		then
			rm -f$vr $b
			a=$e
			b=$f
			y=$z
		else
 			rm -f$vr $f
		fi
	elif test -f "$e" ;then
		x=`find ${e%/*} -noleaf -maxdepth 1 -type f -iname "${e##*/}" -printf %s`
		if test $z -gt $x ;then
			mv -f$vr $f $e
			y=$z
		elif test $z -lt $x ;then
			rm -f$vr $f
			y=$x
		elif test `find ${e%/*} -noleaf -maxdepth 1 -type f -iname "${e##*/}" -newer "$f"` ;then
			rm -f$vr $f
			y=$x
		else
			mv -f$vr $f $e
			y=$z
		fi
		a=$e
		b=
	else
		mv -f$vr $f $e
		a=$e
		b=$f
		y=$z
	fi
}
done
unset IFS
}
